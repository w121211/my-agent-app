# 更新後的 UI 事件流設計

以下是重新設計的事件流，我將可統一處理的事件獨立出來，同時保持命令的特異性：

## 核心統一處理事件

這些是系統中可以統一處理的關鍵事件：

```
/// 聊天更新統一處理
SERVER_CHAT_UPDATED
  → UI_CHAT_CONTENT_REFRESHED        // 更新聊天內容
  → UI_LATEST_MESSAGE_SCROLLED_TO    // 滾動到最新消息
  → UI_CHAT_INPUT_STATE_UPDATED      // 更新輸入區域狀態

/// 樹結構更新統一處理
SERVER_EXPLORER_STRUCTURE_CHANGED    // 所有影響Explorer結構的伺服器事件
  → UI_EXPLORER_TREE_VIEW_UPDATED    // 更新樹視圖

/// 導航路徑更新統一處理
SERVER_NAVIGATION_PATH_CHANGED       // 所有影響導航路徑的操作
  → UI_NAVIGATION_BREADCRUMB_UPDATED // 更新麵包屑導航
```

## 詳細事件流（保持命令特異性）

### Task 相關

#### 創建新任務

```
UI_NEW_TASK_BUTTON_CLICKED
  → UI_PROMPT_INPUT_MODAL_OPENED
    → CLIENT_START_NEW_CHAT_COMMAND
      → SERVER_CHAT_READY
        → UI_CHAT_VIEW_OPENED
        → SERVER_NAVIGATION_PATH_CHANGED

    // 用戶批准任務大綱後
    → CLIENT_CREATE_TASK_COMMAND
      → SERVER_TASK_CREATED
      → SERVER_TASK_LOADED
        → SERVER_EXPLORER_STRUCTURE_CHANGED
```

#### 任務狀態變更

```
UI_TASK_OPTIONS_BUTTON_CLICKED
  → UI_TASK_OPTIONS_MENU_OPENED
    → CLIENT_UPDATE_TASK_STATUS_COMMAND
      → SERVER_TASK_UPDATED
        → UI_TASK_STATUS_BADGE_UPDATED
        → SERVER_EXPLORER_STRUCTURE_CHANGED
```

#### 展開/折疊任務節點

```
UI_TASK_NODE_CLICKED
  → UI_TASK_NODE_EXPANDED_TOGGLED
    → UI_EXPLORER_TREE_VIEW_UPDATED  // 本地UI更新，無需伺服器交互
```

### 子任務相關

#### 點擊子任務節點

```
UI_SUBTASK_NODE_CLICKED
  → UI_SUBTASK_NODE_EXPANDED_TOGGLED
    → UI_EXPLORER_TREE_VIEW_UPDATED  // 本地UI更新
```

#### 使用子任務操作按鈕

```
UI_SUBTASK_START_BUTTON_CLICKED
  → CLIENT_START_SUBTASK_COMMAND
    → SERVER_SUBTASK_STARTED
      → UI_SUBTASK_STATUS_BADGE_UPDATED
      → SERVER_NAVIGATION_PATH_CHANGED
      → SERVER_CHAT_READY
        → UI_CHAT_VIEW_OPENED

UI_SUBTASK_PAUSE_BUTTON_CLICKED
  → CLIENT_PAUSE_SUBTASK_COMMAND
    → SERVER_SUBTASK_PAUSED
      → UI_SUBTASK_STATUS_BADGE_UPDATED
```

#### 子任務選項操作

```
UI_SUBTASK_OPTIONS_BUTTON_CLICKED
  → UI_SUBTASK_OPTIONS_MENU_OPENED
    → CLIENT_SKIP_SUBTASK_COMMAND (如果選擇跳過)
      → SERVER_SUBTASK_UPDATED
      → SERVER_NEXT_SUBTASK_TRIGGERED
        → CLIENT_START_SUBTASK_COMMAND
          → SERVER_SUBTASK_STARTED
            → UI_SUBTASK_STATUS_BADGE_UPDATED
            → SERVER_NAVIGATION_PATH_CHANGED
            → SERVER_EXPLORER_STRUCTURE_CHANGED
```

### 聊天操作

#### 在子任務中創建新聊天

```
UI_SUBTASK_NEW_CHAT_BUTTON_CLICKED
  → CLIENT_START_SUBTASK_NEW_CHAT_COMMAND
    → SERVER_CHAT_READY
      → SERVER_EXPLORER_STRUCTURE_CHANGED
      → UI_CHAT_VIEW_OPENED
      → UI_CHAT_MESSAGE_INPUT_FOCUSED
      → SERVER_NAVIGATION_PATH_CHANGED
```

#### 發送聊天消息

```
UI_CHAT_MESSAGE_ENTERED
  → UI_CHAT_INPUT_SEND_BUTTON_CLICKED
    → CLIENT_SUBMIT_MESSAGE_COMMAND
      → SERVER_MESSAGE_RECEIVED
        → SERVER_CHAT_UPDATED  // 統一處理的關鍵點
      → SERVER_AGENT_PROCESSING_STARTED
        → UI_AGENT_TYPING_INDICATOR_DISPLAYED
        → UI_CHAT_INPUT_DISABLED
      → SERVER_AGENT_RESPONSE_GENERATED
        → SERVER_CHAT_UPDATED  // 統一處理的關鍵點
        → UI_CHAT_INPUT_ENABLED
```

#### 上傳文件附件（MVP忽略）

```
UI_FILE_ATTACHMENT_BUTTON_CLICKED
  → UI_FILE_SELECTOR_OPENED
    → UI_FILE_PREVIEW_DISPLAYED
      → UI_CHAT_INPUT_SEND_BUTTON_CLICKED
        → CLIENT_SUBMIT_MESSAGE_WITH_ATTACHMENT_COMMAND
          → SERVER_FILE_UPLOADED
            → SERVER_CHAT_UPDATED  // 統一處理的關鍵點
```

#### 批准子任務結果

```
UI_CHAT_INPUT_SEND_BUTTON_CLICKED  // 批准作為特殊消息發送
  → CLIENT_SUBMIT_MESSAGE_COMMAND
    → SERVER_MESSAGE_RECEIVED
      → SERVER_CHAT_UPDATED  // 統一處理的關鍵點
    → CLIENT_APPROVE_WORK
      → CLIENT_COMPLETE_SUBTASK_COMMAND
        → SERVER_SUBTASK_COMPLETED
          → UI_SUBTASK_STATUS_BADGE_UPDATED
          → SERVER_EXPLORER_STRUCTURE_CHANGED
        → SERVER_NEXT_SUBTASK_TRIGGERED
          → CLIENT_START_SUBTASK_COMMAND
            → SERVER_SUBTASK_STARTED
              → UI_SUBTASK_STATUS_BADGE_UPDATED
              → SERVER_NAVIGATION_PATH_CHANGED
              → UI_NEXT_SUBTASK_CHAT_OPENED
```

### 文件操作

#### 打開聊天文件

```
UI_CHAT_FILE_NODE_CLICKED
  → CLIENT_OPEN_CHAT_COMMAND
    → SERVER_CHAT_READY
      → UI_CHAT_MESSAGES_VIEW_DISPLAYED
      → SERVER_NAVIGATION_PATH_CHANGED
      → UI_LATEST_MESSAGE_SCROLLED_TO
```

#### 打開文檔文件

```
UI_DOCUMENT_FILE_NODE_CLICKED
  → CLIENT_OPEN_FILE_COMMAND
    → SERVER_FILE_LOADED
      → UI_FILE_CONTENT_VIEW_DISPLAYED
      → SERVER_NAVIGATION_PATH_CHANGED
```

#### 編輯文件（MVP忽略）

```
UI_EDIT_BUTTON_CLICKED
  → UI_FILE_EDIT_MODE_ENABLED
    → UI_FILE_CONTENT_EDITED
      → UI_SAVE_BUTTON_CLICKED
        → CLIENT_SAVE_FILE_COMMAND
          → SERVER_FILE_SAVED
            → UI_FILE_CONTENT_VIEW_DISPLAYED
            → SERVER_EXPLORER_STRUCTURE_CHANGED  // 如果文件名稱有變更
```

#### 下載文件（MVP忽略）

```
UI_DOWNLOAD_BUTTON_CLICKED
  → CLIENT_DOWNLOAD_FILE_COMMAND
    → UI_FILE_DOWNLOAD_INITIATED
```
