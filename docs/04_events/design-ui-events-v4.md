# 層級式事件流設計

以下是採用分層結構重新設計的事件流，更清晰地表示UI事件、客戶端命令和伺服器事件之間的因果關係和時間差：

## Task

### 創建新任務

> 標題都改成英文

```
UI_NEW_TASK_BUTTON_CLICKED
  → UI_PROMPT_INPUT_MODAL_OPENED

    （透過 chat 互動式了解 user 的 taks 需求 -> ai 提出 task outline -> user approve）
    （在流程上與 new chat 相同，都是開啟一個新對話，只是在 chat context 上有差）
    → CLIENT_START_NEW_CHAT_COMMAND
      → SERVER_CHAT_READY
        → UI_CHAT_VIEW_OPENED

    （直到 user approve task outline）
    → CLIENT_CREATE_TASK_COMMAND
      → SERVER_TASK_CREATED
      → SERVER_TASK_LOADED
        → UI_EXPLORER_TREE_VIEW_UPDATED
```

### 任務狀態變更（MVP 略過）

```
UI_TASK_OPTIONS_BUTTON_CLICKED
  → UI_TASK_OPTIONS_MENU_OPENED
    → CLIENT_UPDATE_TASK_STATUS_COMMAND
      → SERVER_TASK_UPDATED
        → UI_TASK_STATUS_BADGE_UPDATED
```

### 展開/折疊任務節點

```
UI_TASK_EXPAND_COLLAPSE_ICON_CLICKED
  → UI_TASK_NODE_EXPANDED_TOGGLED
    → UI_EXPLORER_TREE_VIEW_UPDATED
```

> 不用刻意點 expand icon，而是點 tree node，針對 task, subtask 這種 folders （他們實際上就是 folders），就會展開/折疊，同時 main panel 不變（類似 vscode file explorer 對點擊 folder 時的做法）

## Subtask

### 開始子任務

```
UI_SUBTASK_NODE_CLICKED
  → CLIENT_START_SUBTASK_COMMAND
    → SERVER_SUBTASK_STARTED
      → UI_SUBTASK_STATUS_BADGE_UPDATED
      → UI_NAVIGATION_BREADCRUMB_UPDATED
      → UI_LATEST_CHAT_FILE_OPENED
```

> UI_SUBTASK_NODE_CLICKED 點這個應該是會展開折疊，只有明確點擊 [start] [pause] button 才會啟動、暫停 subtask

### 子任務操作按鈕

```
UI_SUBTASK_ACTION_BUTTON_CLICKED
  → CLIENT_START_SUBTASK_COMMAND
    → SERVER_SUBTASK_STARTED
      → UI_SUBTASK_STATUS_BADGE_UPDATED
  → CLIENT_START_NEW_CHAT_COMMAND
    → SERVER_CHAT_READY
      → UI_CHAT_VIEW_OPENED
```

> 這個跟 開始子任務 有點重複了，可合併兩者

### 子任務選項（MVP忽略）

```
UI_SUBTASK_OPTIONS_BUTTON_CLICKED
  → UI_SUBTASK_OPTIONS_MENU_OPENED
    → CLIENT_SKIP_SUBTASK_COMMAND (若選擇略過)
      → SERVER_SUBTASK_UPDATED
      → SERVER_NEXT_SUBTASK_TRIGGERED
        → CLIENT_START_SUBTASK_COMMAND
          → SERVER_SUBTASK_STARTED
            → UI_NEXT_SUBTASK_HIGHLIGHTED
```

### 在子任務下創建新聊天

```
UI_NEW_CHAT_BUTTON_CLICKED
  → CLIENT_START_NEW_CHAT_COMMAND
    → SERVER_CHAT_READY
      → UI_CHAT_FILE_NODE_ADDED_TO_EXPLORER
      → UI_CHAT_VIEW_OPENED
      → UI_CHAT_MESSAGE_INPUT_FOCUSED
```

> UI_NEW_CHAT_BUTTON_CLICKED 的流程就是 new chat 的流程，在子任務下面新增只是會有先針對子任務的特別設計 -> 可能要明確區分是task new chat, subtask new chat, or new chat（我不確定這個該如何命名比較適合）
> 我覺得針對 workspace 結構更新可以用別的事件去處理

## 檔案操作事件流

### 開啟聊天檔案

```
UI_CHAT_FILE_NODE_CLICKED
  → CLIENT_OPEN_CHAT_COMMAND
    → SERVER_CHAT_READY
      → UI_NAVIGATION_BREADCRUMB_UPDATED
      → UI_CHAT_MESSAGES_VIEW_DISPLAYED
      → UI_LATEST_MESSAGE_SCROLLED_TO
```

### 開啟文檔檔案

```
UI_DOCUMENT_FILE_NODE_CLICKED
  → CLIENT_OPEN_FILE_COMMAND
    → SERVER_FILE_LOADED
      → UI_NAVIGATION_BREADCRUMB_UPDATED
      → UI_FILE_CONTENT_VIEW_DISPLAYED
```

### 檔案選項操作（MVP忽略）

```
UI_FILE_OPTIONS_BUTTON_CLICKED
  → UI_FILE_OPTIONS_MENU_OPENED
    → UI_FILE_EDIT_MODE_ENABLED (若選擇編輯)

    → CLIENT_DOWNLOAD_FILE_COMMAND (若選擇下載)
      → UI_FILE_DOWNLOAD_INITIATED

    → UI_CONFIRMATION_DIALOG_SHOWN (若選擇刪除)
      → CLIENT_DELETE_FILE_COMMAND
        → SERVER_FILE_DELETED
          → UI_FILE_NODE_REMOVED_FROM_EXPLORER
```

## 聊天操作事件流

### 發送聊天訊息

```
UI_CHAT_MESSAGE_ENTERED
  → UI_SEND_BUTTON_CLICKED
    → CLIENT_SUBMIT_MESSAGE_COMMAND
      → SERVER_MESSAGE_RECEIVED
      → SERVER_CHAT_UPDATED
        → UI_USER_CHAT_MESSAGE_DISPLAYED
        → UI_AGENT_TYPING_INDICATOR_DISPLAYED
      → SERVER_AGENT_RESPONSE_GENERATED
      → SERVER_CHAT_UPDATED
        → UI_ASSISTANT_CHAT_MESSAGE_DISPLAYED
        → UI_LATEST_MESSAGE_SCROLLED_TO
```

> send button 不夠清晰，例如像是 chat input send button（或其他更好的命名）會更好
> UI_AGENT_TYPING_INDICATOR_DISPLAYED -> 可能還要有個 chat input disabled

### 上傳檔案附件（MVP忽略）

```
UI_FILE_ATTACHMENT_BUTTON_CLICKED
  → UI_FILE_SELECTOR_OPENED
    → UI_FILE_PREVIEW_DISPLAYED
      → UI_SEND_BUTTON_CLICKED
        → CLIENT_SUBMIT_MESSAGE_WITH_ATTACHMENT_COMMAND
          → SERVER_FILE_UPLOADED
          → SERVER_CHAT_UPDATED
            → UI_USER_CHAT_MESSAGE_WITH_ATTACHMENT_DISPLAYED
```

### 批准子任務成果

```
UI_APPROVAL_MESSAGE_SENT
  → CLIENT_SUBMIT_MESSAGE_COMMAND
    → SERVER_MESSAGE_RECEIVED
    → SERVER_CHAT_UPDATED
      → UI_USER_CHAT_MESSAGE_DISPLAYED
    → CLIENT_APPROVE_WORK
      → CLIENT_COMPLETE_SUBTASK_COMMAND
        → SERVER_SUBTASK_COMPLETED
          → UI_SUBTASK_STATUS_BADGE_UPDATED
        → SERVER_NEXT_SUBTASK_TRIGGERED
          → CLIENT_START_SUBTASK_COMMAND
            → SERVER_SUBTASK_STARTED
              → UI_NEXT_SUBTASK_CHAT_OPENED
```

## 檔案預覽與編輯操作事件流

### 編輯檔案

```
UI_EDIT_BUTTON_CLICKED
  → UI_FILE_EDIT_MODE_ENABLED
    → UI_FILE_CONTENT_EDITED
      → UI_SAVE_BUTTON_CLICKED
        → CLIENT_SAVE_FILE_COMMAND
          → SERVER_FILE_SAVED
            → UI_FILE_CONTENT_VIEW_DISPLAYED
```

### 下載檔案（MVP忽略）

```
UI_DOWNLOAD_BUTTON_CLICKED
  → CLIENT_DOWNLOAD_FILE_COMMAND
    → UI_FILE_DOWNLOAD_INITIATED
```

### 分享檔案（MVP忽略）

```
UI_SHARE_BUTTON_CLICKED
  → UI_SHARE_OPTIONS_MENU_OPENED
    → CLIENT_SHARE_FILE_COMMAND
      → UI_FILE_SHARE_LINK_GENERATED
        → UI_SHARE_LINK_DIALOG_DISPLAYED
```
